# WebRTC-WebTorrent-tracker-communication-demo

## Prerequirements

- node>=16.x.x, npm>=8.x.x

## Getting Started

### Run the Server

Open the [dApp.html](./dApp.html) file and your dev tools to see the console log outputs.

### Explanation

The server (dApp) is just a blank VSCode HTML5 template with the following changes:

1. Import Meerkat in the header

```html
<script src="https://fabianbormann.github.io/meerkat/meerkat.min.js"></script>
```

2. Create a new Meerkat instance with a fixed seed to make Meerkat always generating the same identifier (address)

```html
<script>
  const meerkat = new Meerkat({
    seed: 'BofdLENCoCxJroaUcjbj9gyhiozjR6o6ZnxgMD6TgtvpS6DbGsWi',
    announce: [
      'wss://tracker.files.fm:7073/announce',
      'wss://tracker.btorrent.xyz',
      'ws://tracker.files.fm:7072/announce',
      'wss://tracker.openwebtorrent.com:443/announce',
    ],
    loggingEnabled: true,
  });

  const logger = meerkat.logger;
  logger.info(`The generated meerkat address is: ${meerkat.address()}`);

  var connected = false;
  meerkat.on('connections', function (clients) {
    if (clients == 0 && connected == false) {
      connected = true;
      logger.info('server ready');
    }
    logger.info(`${clients} clients connected`);
  });

  meerkat.register('api', function (address, args, callback) {
    const api = { version: args.api.version, address: address };

    for (method of args.api.methods) {
      api[method] = () =>
        new Promise((resolve, reject) => {
          meerkat.rpc(address, method, {}, (result) => resolve(result));
        });
    }

    window.cardano = window.cardano || {};
    window.cardano[args.api.name] = api;
    logger.info(`injected api of ${args.api.name} into window.cardano`);
  });
</script>
```

This meerkat instance is now waiting for clients to connect and it will provide an api rpc method to allow a client to inject it's api to the global window object.

## Client (aka Wallet App)

### Run the Client

```zsh
cd ionic-app
npm i
npm start
```

#### Testing (PoC)

Once you have the server and client running you should see something like

```js
[info] [Meerkat]: injected api of boostwallet into window.cardano
```

in your dApp logs. Now you can issue

```js
window.cardano.boostwallet
  .getRewardAddresses()
  .then((result) => console.log(result));
```

to execute the remote call and get the reward address from your Wallet (dApp.html).

### Explanation

The wallet app is actually the result of:

1. The blank ionic react template with Meerkat as an additional npm package

```zsh
ionic start ionic-app blank --type react
cd ionic-app
npm i @fabianbormann/meerkat
```

2. Meerkat import and initialization added to the [index.tsx](./ionic-app/src/index.tsx) file

```ts
import Meerkat from '@fabianbormann/meerkat';

...

const meerkat = new Meerkat({
  identifier: 'bZqy8Big6pWTDeFTHz2Z6KLmuniqwRNXMT',
  announce: [
    'wss://tracker.files.fm:7073/announce',
    'wss://tracker.btorrent.xyz',
    'ws://tracker.files.fm:7072/announce',
    'wss://tracker.openwebtorrent.com:443/announce',
  ],
});

const logger = meerkat.logger;
logger.info(`The generated meerkat address is: ${meerkat.address()}`);

meerkat.on('server', function () {
  console.log('[info]: connected to server');
  meerkat.rpc(
    'bZqy8Big6pWTDeFTHz2Z6KLmuniqwRNXMT',
    'api',
    {
      api: {
        version: '1.0.3',
        name: 'boostwallet',
        methods: ['getRewardAddresses'],
      },
    },
    () => {}
  );
});

meerkat.register(
  'getRewardAddresses',
  (address: string, args: any, callback: Function) => {
    callback(['e1820506cb0ce54ae755b2512b6cf31856d7265e8792cb86afc94e0872']);
  }
);
```

The identifier bZqy8Big6pWTDeFTHz2Z6KLmuniqwRNXMT is the address generated by the Meerkat server instance (dApp.html).
After connecting the client will inject it's api (available rpc methods) into the dApp.html by using it's api rpc method.
